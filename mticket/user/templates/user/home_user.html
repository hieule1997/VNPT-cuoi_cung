{% extends 'user/base.html' %}
    {% load staticfiles %}
{% block title %}Home{% endblock %}
{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <section class="content-header">
      <h1>
        Yêu cầu của bạn
      </h1>
      <ol class="breadcrumb">
        <li><a ><i class="fa fa-home"></i> Trang chủ</a></li>
        <li class="active">Yêu cầu</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
        {% csrf_token %}
      <div class="row">
        <div class="col-xs-12">
            <div class="box">
            <div class="box-header">
                <h3 style="float:left ">Yêu cầu tự xử lý</h3>
                <button style="float:right" class="btn btn-lg btn-primary" data-toggle="modal" data-target="#id02">
                    <span class="glyphicon glyphicon-plus"></span> Tạo yêu cầu tự xử lý
                </button>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <table style="width:100%;" id="list_tk_tu_xu_ly" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên khách hàng</th>
                        <th>Dịch vụ</th>
                        <th>Loại sự cố</th>
                        <th>Nội dung sự cố</th>
                        <th>Ngày tạo</th>
                        <th>Thời gian xử lý</th>
                        <th>Trạng thái</th>
                        <th>Tùy chọn</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
              </table>
            </div>
          </div>
            <div class="box">
            <div class="box-header">
                <h3 style="float:left;" >Yêu cầu gửi đi</h3>
                <button style="float:right" class="btn btn-lg btn-primary" data-toggle="modal" data-target="#id02">
                    <span class="glyphicon glyphicon-send"></span> Tạo yêu cầu gửi đi
                </button>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
              <table style="width:100%;" id="list_tk_gui_di" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên khách hàng</th>
                        <th>Thông tin khách hàng</th>
                        <th>Loại sự cố</th>
                        <th>Nội dung sự cố</th>
                        <th>Ngày tạo</th>
                        <th>Thời gian xử lý</th>
                        <th>Trạng thái</th>
                        <th>Người xử lý</th>
                        <th>Tùy chọn</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    <div class="modal fade" id="id03" role="dialog" >
        <div class="modal-dialog modal-lg">
            <div class="modal-content ">
                <form method="POST" enctype="multipart/form-data" onsubmit="return validateSize()">
                    <div class="modal-header">
                        <h4 class="modal-title">Yêu cầu mới</h4>
                    </div>
                     <div class="modal-body form-group">
                         <label>Tên khách hàng</label>
                         <input class="form-control" name="client" required>
                         <label>Thông tin khách hàng</label>
                         <textarea class="form-control" name="info_client" required></textarea>
                         <label>Loại sự cố</label>
                         <input class="form-control" name="loai_su_co" required>
                         <label>Dịch vụ</label>
                         <select name="service" class="form-control" id="service_select">
                             <option></option>
                         </select>
                         <label>Nội dung sự cố</label>
                         <textarea class="form-control" name="content" required></textarea>
                         <label>Mức ưu tiên</label>
                         <select name="lv_priority" class="form-control" id="lv_select">
                             <option value="0">Thấp</option>
                             <option value="1">Trung bình</option>
                             <option value="2">Cao</option>
                         </select>
                         <label>Đính kèm</label>
                         <input type="file" class="form-control" accept="image/*" name="attach" id="attach">
                     </div>
                    <div class="modal-footer">
                         <button type="submit" class="btn btn-primary" value="OK" id="i_submit" onsubmit="return validateSize()">Gửi</button>
                         <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    </div>
              </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="id02" role="dialog" >
        <div class="modal-dialog modal-lg">
            <div class="modal-content ">
                <form method="POST" enctype="multipart/form-data" onsubmit="return validateSize()">
                    <div class="modal-header">
                        <h4 class="modal-title">Yêu cầu mới</h4>
                    </div>
                     <div class="modal-body form-group">
                         {% csrf_token %}
                         {% for key, value in form.error.items %}
                         {{value}}
                         {% endfor%}
                         <label>Tên khách hàng</label>
                         {{form.client}}
                         <br>
                         <label>Thông tin khách hàng</label>
                         {{form.info_client}}
                         <br>
                         <label>Loại sự cố</label>
                         {{form.loai_su_co}}
                         <br>
                         <label for="title"><b>Tiêu đề</b></label>
                         {{form.title}}
                         <br>
                         <label for="topic"><b>Dịch vụ</b></label>
                         <select name="service" class="form-control" id="mySelect">
                             {% for sv in service %}
                                <option value="{{sv.name}}" name="{{service}}">{{sv.name}} - {{sv.description}}</option>
                             {% endfor %}
                         </select>
                         <br>
                         <label for="level"><b>Mức ưu tiên</b></label>
                         <select name="lv_priority" class="form-control" id="lv_select">
                             <option value="0">Thấp</option>
                             <option value="1">Trung bình</option>
                             <option value="2">Cao</option>
                         </select>
                         <br>
                         <label for="content"><b>Nội dung</b></label>
                         {{form.content}}
                         <br>
                         <label for="attach"><b>Đính kèm</b></label><br />
                         <input type="file" class="form-control" accept="image/*" name="attach" id="attach">
                         <div><font id="invalid-msg" color="red" size="5"></font></div>

                     </div>
                    <div class="modal-footer">
                         <button type="submit" class="btn btn-primary" value="OK" id="i_submit" onsubmit="return validateSize()">Gửi</button>
                         <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                     </div>
              </form>
            </div>
        </div>
    </div>
    </section>
  </div>
{% endblock %}
{% block js%}
<script>
        $(document).ready(function(){
            var table = $('#list_tk_tu_xu_ly').DataTable({
                "ajax": {
                    "type": "GET",
                    "url": location.href +"tu_xu_ly",
                    "contentType": "application/json; charset=utf-8",
                    "data": function(result){
                        return JSON.stringify(result);
                    }
                },
                'dom': 'Rlfrtip',
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "order": [[ 0, "desc" ]],
                "displayLength": 25,
            });
            var table = $('#list_tk_gui_di').DataTable({
                'dom': 'Rlfrtip',
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "order": [[ 0, "desc" ]],
                "displayLength": 25,
            });
            $('body').on('click', '.close_ticket', function(){
                var id = $(this).attr('id');
                var token = $("input[name=csrfmiddlewaretoken]").val();
                var mgs = 'Yêu cầu số ' +id+' được đóng bởi '+userName;
                var message = []
                if(confirm("Bạn có chắc không ?")){
                    $.ajax({
                        type:'POST',
                        url:location.href,
                        data: {'tkid':id, 'csrfmiddlewaretoken':token},
                        success: function(){
                            // window.location.reload();
                            $("#list_tk_user").DataTable().ajax.reload();
                            countdowntime();
                            var array = $('#hd'+id).html().split("<br>");
                            for (i = 0; i < array.length-1; i++) {
                                var agentName = array[i].replace(/\s/g,'');
                                message.push(agentName);
                            }

                            message.push(mgs);
                            var date = formatAMPM(new Date());
                            var chatSocket1 = new WebSocket(
                            'ws://' + window.location.host +
                            '/ws/agent/agent+group_agent_Socket/');
                            chatSocket1.onopen = function (event) {
                                chatSocket1.send(JSON.stringify({
                                    'message' : message,
                                    'time': date
                                }));

                                chatSocket1.send(JSON.stringify({
                                    'message' : 'reload_home_agent',
                                    'time': date
                                }));
                            };
                        }
                    });
                }

            });

            $("body").on('click', '#chat_with_agent', function(){
                var tkid = $(this).children('input').val();
                $('body .chat'+tkid).show();
                $("body .mytext").focus();

                if (typeof(Storage) !== "undefined") {
                    var herf = $(this).attr('href');
                    var chat = herf.substring(herf.indexOf("(")+1, herf.indexOf(")"));
                    // Gán dữ liệu
                    sessionStorage.setItem(tkid, chat);

                    // Lấy dữ liệu
                } else {
                    document.write('Trình duyệt của bạn không hỗ trợ local storage');
                }

                if (dict_ws[tkid] == undefined){
                    dict_ws[tkid] = new WebSocket(
                    'ws://' + window.location.host +
                    '/ws/' + tkid + '/');
                }

                var me = {};
                me.avatar = "https://cdn2.iconfinder.com/data/icons/perfect-flat-icons-2/512/User_man_male_profile_account_person_people.png";

                var you = {};
                you.avatar = "https://cdn2.iconfinder.com/data/icons/rcons-users-color/32/support_man-512.png";


                //-- No use time. It is a javaScript effect.
                function insertChat(who, text, time){
                    if (time === undefined){
                        time = 0;
                    }
                    var control = "";
                    var date = time;

                    if (who == "me"){
                        control = '<li style="width:100%">' +
                                        '<div class="msj macro">' +
                                        '<div class="avatar"><img class="img-circle" style="width:100%;" src="'+ me.avatar +'" /></div>' +
                                            '<div class="text text-l">' +
                                                '<p>'+ text +'</p>' +
                                                '<p><small>'+date+'</small></p>' +
                                            '</div>' +
                                        '</div>' +
                                    '</li>';
                    }else{
                        control = '<li style="width:100%;">' +
                                        '<div class="msj-rta macro">' +
                                            '<div class="text text-r">' +
                                                '<p>'+text+'</p>' +
                                                '<p><small>'+date+'</small></p>' +
                                            '</div>' +
                                        '<div class="avatar" style="padding:0px 0px 0px 10px !important"><img class="img-circle" style="width:100%;" src="'+you.avatar+'" /></div>' +
                                '</li>';
                    }
                    setTimeout(
                        function(){
                            $("body #chat"+tkid+" .frame > ul").append(control).scrollTop($("body #chat"+tkid+" .frame > ul").prop('scrollHeight'));
                        }, time);

                }


                dict_ws[tkid].onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    var message = data['message'];
                    var who = data['who'];
                    var time = data['time'];
                    insertChat(who, message, time);
                };

            });

        });

</script>


<script type="text/javascript" >
    $('#invalid-msg').html("");
    function validateSize(){
        if(($("#attach"))[0].files[0].size > 10485760){
            $('#invalid-msg').html("maximum size is 10MB");
            return false;
        }
        return true;
    }

    $(document).ready(function(){
        // sau khi submit thanh cong thi send message tu websocket len server
        $("#id02").submit(function() {
            var chatSocket1 = new WebSocket(
            'ws://' + window.location.host +
            '/ws/agent/agent+group_agent_Socket/');
            var message = '';
            var topic = document.getElementById("mySelect").value;
            var topic_name = $("#mySelect option[value='"+topic+"']").attr("name");
            message = 'Bạn có một yêu cầu mới!'+topic_name;

            var date = formatAMPM(new Date());
            chatSocket1.onopen = function (event) {
                chatSocket1.send(JSON.stringify({
                    'message' : message,
                    'time' : date
                }));
            };
        });
    });
</script>
{% endblock %}